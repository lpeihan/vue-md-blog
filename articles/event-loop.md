{
  "title": "单线程和事件循环",
  "date": "2018-04-28",
  "tags": "javascript"
}

1. 单线程
   
    * 单线程的`JS`引擎

   所谓单线程，是指在`JS`引擎中负责解释和执行`JavaScript`代码的线程只有一个，称之主线程。
   
    * 多线程的浏览器

   但是实际浏览器上还存在其他的线程。例如：界面渲染线程,处理`AJAX`请求的线程、处理`DOM`事件的线程、定时器线程、读写文件的线程等等。
   
   * `js引擎线程`和`界面渲染引擎`互斥
   
    `界面渲染引擎`负责渲染浏览器`html`元素，当界面需要重绘`Repaint`或由于某种操作引发回流`reflow`时,该线程就会执行。在脚本中对界面进行更新操作，如添加结点、删除结点或改变结点的外观等更新并不会立即体现出来，这些操作将保存在一个队列中，待`JavaScript`引擎空闲时才有机会渲染出来.
  

2. 可视化描述

    ![stack](http://note.youdao.com/yws/api/personal/file/391F49F1EB8040D194BD6B0F3DFE5969?method=download&shareKey=cdf29e565ce8891507a246658f8a5196)

<!-- lph -->
3. 栈`stack`

   函数调用形成了一个栈帧。

   ```javascript
   function foo(b) {
     var a = 10;
     return a + b + 11;
   }

   function bar(x) {
     var y = 3;
     return foo(x * y);
   }

   console.log(bar(7));
   ```

   当调用`bar`时，创建了第一个帧 ，帧中包含了`bar`的参数和局部变量。当`bar`调用`foo`时，第二个帧就被创建，并被压到第一个帧之上，帧中包含` foo`的参数和局部变量。当`foo`返回时，最上层的帧就被弹出栈。当 `bar`返回的时候，栈就空了。
   

4. 堆`heap`

   对象被分配在一个堆中，一个用以表示一个内存中大的未被组织的区域。

   当我们需要访问引用类型（如对象，数组，函数等）的值时，首先从栈中获得该对象的地址指针，然后再从堆内存中取得所需的数据。

5. 消息队列`message queue`

   当事件触发时，比如鼠标点击，`ajax`执行完成，`setTimeout`时间到了，表示异步任务完成，会将事件监听器函数封装成一条消息放到消息队列中，等待主线程执行。

   一个`JavaScript`运行时包含了一个待处理的消息队列。每一个消息都与一个回调函数相关联。当栈为空时，从队列中取出一个消息进行处理。
   

6. 事件循环`event loop`

   为什么有个事件呢？

   ```
   因为消息队列中的每条消息实际上都对应着一个事件。
   ```

   主线程只会做一件事情，就是从消息队列里面取消息、执行消息，再取消息、再执行。当消息队列为空时，就会等待直到消息队列变成非空。

   ```javascript
   while(true) {
     var message = queue.get();
     execute(message);
   }
   ```
   
    每次`event loop`查看消息队列，找到最老的消息，压入栈，执行之，执行完了，就进行一次视图渲染。周而复始，直到所有消息队列都执行完毕。

    ![event-loop](http://note.youdao.com/yws/api/personal/file/B4284E1E3142411F982C8E813E3B544A?method=download&shareKey=cdf29e565ce8891507a246658f8a5196)
    
    （`Event Loop`是 `JavaScript` 的运行环境（比如浏览器）提供的机制）

7. 添加消息

   在浏览器里，当一个事件出现且有一个事件监听器被绑定时，消息会被随时添加。如果没有事件监听器，事件会丢失。所以点击一个附带点击事件处理函数的元素会添加一个消息。其它事件亦然。

8. 生产者和消费者

   从生产者与消费者的角度看，异步过程是这样的：

   工作线程是生产者，主线程是消费者(只有一个消费者)。工作线程执行异步任务，执行完成后把对应的回调函数封装成一条消息放到消息队列中；主线程不断地从消息队列中取消息并执行，当消息队列空时主线程阻塞，直到消息队列再次非空。
   
9. 参考
   
   https://segmentfault.com/a/1190000004322358
   
   https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop